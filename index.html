<!DOCTYPE html>
<html>
  </head>
    <meta charset="UTF-8">
    <script type="text/javascript">
      // Global variables
      const BYTES_PER_CHUNK = 512 * 1024; // Chunk sizes.
      var chunks; // Chunks, value that gets decremented
      var chunks_total; // Total  chunks
      var blob_content = new Blob(); // Chunk content
      var start = 0; // Start read blob
      var end; // End read blob
      var index = 0; // File index
      // var blob = new Blob(); // Blob with file

      //####################################################
      // Calculates chunks
      //####################################################
      function sendRequest () {
      
        blob = document.getElementById("fileToUpload").files[0];

        // Calculate the number of chunks
        chunks = Math.ceil (blob.size / BYTES_PER_CHUNK);
        chunks_total = chunks;
        end = BYTES_PER_CHUNK;

        upload_file ();
      }

      //####################################################
      // Upload chunks and adjustes progress bars
      //####################################################
      function upload_file () {

        chunk = blob.slice (start, end);
        index++;

        var worker_reader = new Worker('worker_reader.js');
        var worker_uploader = new Worker('worker_uploader.js');
  
        worker_reader.onmessage = function (event) {
          uload_array={"size": blob.size, "name": blob.name, "content": event.data, "index": index};
          document.getElementById("back_message").innerHTML = "Writing " + blob.name + " " + index;
          worker_reader.terminate();
          return worker_uploader.postMessage(uload_array);
        }
        
        worker_uploader.onmessage = function (event) {
          if (indexÂ < chunks_total) {
            start = end;
            end = start + BYTES_PER_CHUNK;
            var percentageDiv = document.getElementById ("percent");
            var progressBar = document.getElementById ("progressBar");
    
            percentageDiv.innerHTML = "0%";
            progressBar.max = chunks_total;
    
            progressBar.value = index;
    
            percentageDiv.innerHTML = Math.round (index/chunks_total * 100) + "%";
            document.getElementById("back_message").innerHTML = "Reading " + blob.name + " " + index;
            worker_uploader.terminate();
            return upload_file ();
          }
          else {
            upload_merge ();
          }
        }
        document.getElementById("back_message").innerHTML = "Reading " + blob.name + " " + index;
        worker_reader.postMessage(chunk);
      }

      //#####################################################
      // Merge all uploaded chunks and adjustes progress bars
      //#####################################################
      function sleep (sleepDuration) {
        var now = new Date ().getTime ();
        while (new Date ().getTime () < now + sleepDuration){ /* do nothing */ } 
      }

      //#####################################################
      // Merge all uploaded chunks and adjustes progress bars
      //#####################################################
      function upload_merge () {
        var xhr;
        var fd;
        var percentageDiv = document.getElementById ("percent");
        var progressBar = document.getElementById ("progressBar");
        
        percentageDiv.innerHTML = "100%";
        progressBar.value = chunks_total;
        document.getElementById("back_message").innerHTML="Procesing ...";
        xhr = new XMLHttpRequest ();

        fd = new FormData ();
        fd.append ("name", blob.name);
        fd.append ("index", chunks_total);

        xhr.open ("POST", "merge.php", false);
        xhr.send (fd);
        document.getElementById("back_message").innerHTML=xhr.responseText;
      }

      //#####################################################
      // Start script after click on Send
      // Check is file exists
      //#####################################################
      function startX() {
        var xhr_fe;
        var blob = document.getElementById ('fileToUpload').files[0];

        xhr_fe = new XMLHttpRequest ();

        xhr_fe.open ("POST", "file_exists.php", false);
        xhr_fe.setRequestHeader ("X-File-Name", blob.name);
        xhr_fe.send ();
        if (xhr_fe.responseText == "Uploading ...") {
          document.getElementById("back_message").innerHTML=xhr_fe.responseText;
          sendRequest ();
        }
        else {
          document.getElementById("back_message").innerHTML="File exists";
        }
      }
    </script>
  </head>
  <body>
    <input type="file" name="file" id="fileToUpload"> <button onclick="startX()">Send</button>
    <progress id="progressBar" value="0" max="100"></progress><span id="percent"></span>
    <p><span id="back_message"></span></p>
  </body>
<html>