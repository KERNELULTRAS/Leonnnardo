<!DOCTYPE html>
<html>
  </head>
    <meta charset="UTF-8">
    <script type="text/javascript">
      // Global variables
      const BYTES_PER_CHUNK = 512 * 1024; // Chunk sizes.
      var chunks; // Chunks, value that gets decremented
      var chunks_total; // Total  chunks
      var blob_content = new Blob();

      //####################################################
      // Calculates chunks
      //####################################################
      function sendRequest () {
        var xhr;
        var blob = document.getElementById("fileToUpload").files[0];
      
        var start = 0;
        var end;
        var index = 0;

        // Calculate the number of chunks
        chunks = Math.ceil (blob.size / BYTES_PER_CHUNK);
        chunks_total = chunks;

        while (start < blob.size) {
          end = start + BYTES_PER_CHUNK;
          if (end > blob.size) {
            end = blob.size;
          }

          uploadFile (blob, index, start, end);

          start = end;
          index++;
        }
      }
      //####################################################
      // Upload chunks and adjustes progress bars
      //####################################################
      function uploadFile (blob, index, start, end) {
        var xhr;
        var chunk;

        xhr = new XMLHttpRequest ();

        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4 && xhr.status == 200) {
            chunks--;
            // if we have finished all chunks
            if (chunks == 0) {
               mergeFile (blob);
            }
          }
        }

        var reader = new FileReader();
    
        // If we use onloadend, we need to check the readyState.
        reader.onloadend = function(evt) {
          if (evt.target.readyState == FileReader.DONE) { // DONE == 2
            blob_content = evt.target.result;
          }
        };

        chunk = blob.slice (start, end);
        reader.readAsBinaryString(chunk);

        document.getElementById('back_message').textContent = blob_content;

        var percentageDiv = document.getElementById ("percent");
        var progressBar = document.getElementById ("progressBar");

        percentageDiv.innerHTML = "0%";
        progressBar.max = chunks_total;

        progressBar.value = chunks_total - chunks;

        percentageDiv.innerHTML = Math.round ((chunks_total-chunks)/chunks_total * 100) + "%";

        xhr.open ("post", "upload.php", false);
        xhr.setRequestHeader ("X-File-Name", blob.name); // custom header with filename and full size
        xhr.setRequestHeader ("X-File-Size", blob.size);
        xhr.setRequestHeader ("X-Index", index); // part identifier
        xhr.send (blob_content);
        // xhr.send (chunk);
      }
      //#####################################################
      // Merge all uploaded chunks and adjustes progress bars
      //#####################################################
      function mergeFile (blob) {
        var xhr;
        var fd;
        var percentageDiv = document.getElementById ("percent");
        var progressBar = document.getElementById ("progressBar");
        
        percentageDiv.innerHTML = "100%";
        progressBar.value = chunks_total;
        document.getElementById("back_message").innerHTML="Procesing ...";
        xhr = new XMLHttpRequest ();

        fd = new FormData ();
        fd.append ("name", blob.name);
        fd.append ("index", chunks_total);

        xhr.open ("POST", "merge.php", false);
        xhr.send (fd);
        document.getElementById("back_message").innerHTML=xhr.responseText;
      }

      //#####################################################
      // Start script after click on Send
      // Check is file exists
      //#####################################################
      function start () {
        var xhr_fe;
        var blob = document.getElementById ('fileToUpload').files[0];

        xhr_fe = new XMLHttpRequest ();

        xhr_fe.open ("POST", "file_exists.php", false);
        xhr_fe.setRequestHeader ("X-File-Name", blob.name);
        xhr_fe.send ();
        if (xhr_fe.responseText == "Uploading ...") {
          document.getElementById("back_message").innerHTML=xhr_fe.responseText;
          sendRequest ();
        }
        else {
          document.getElementById("back_message").innerHTML="File exists";
        }
      }
    </script>
  </head>
  <body>
    <input type="file" name="file" id="fileToUpload"> <button onclick="start()">Send</button>
    <progress id="progressBar" value="0" max="100"></progress><span id="percent"></span>
    <p><span id="back_message"></span></p>
  </body>
<html>